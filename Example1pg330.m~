%% Numerical solution of GPE using TSSP
% Ref: Bao et al. Jour of Comp Phys 187 (2003) 318-342

clear all; close all; clc;

vareps = 0.1;
kappa1 = 1.2649;
a = -16; b = 16;

h = 1/16;          % h is the mesh size: h = (b-a)/M
M = round(1/h*(b-a));
k = 0.01;

x = a:h:b;
l = -M/2:(M/2-1);
j_id = 0:(M-1);
mu_l = 2*pi*l/(b-a);

% S0 = -log(exp(x)+exp(-x));
% psi_x = exp(-x.^2).*(1+0.2*cos(x/sqrt(vareps)).*cos(x/sqrt(vareps))).*exp(1i/vareps.*S0);
psi_x = 1/(pi*vareps*10)^(1/4)*exp(-x.^2/2/vareps/10);

Nk = -10/k;
idd = intersect(find(x<1.5), find(x>-1.5));

abc = zeros(length(idd),Nk);
sigm_w = zeros(size(1:Nk));
x_com = zeros(size(1:Nk));

for kk = 1:Nk
    psi_star = exp(-1i* (x.^2/2 + kappa1*abs(psi_x).^2)...
                        *k/2/vareps)                            .*psi_x;

    
    psi_starHat = psi_star(1:M)*exp(-1i*(x(1:M)-a)'*mu_l);
    psi_doubleStar = 1/M * (exp(-1i*vareps*k*mu_l.^2/2).*psi_starHat) * exp(1i*mu_l'*(x(1:M)-a));
    
    psi_x(1:length(j_id)) = exp(-1i*(x(1:M).^2/2+kappa1*abs(psi_doubleStar).^2)*k/2/vareps).*psi_doubleStar;
    psi_x(M+1)=psi_x(1);

    abc(:,kk) = abs(psi_x(idd)).^2;
    aa = abs(psi_x).^2;

    x_av = sum(x.*aa*h);
    x_com(kk) = x_av;
    sigma_sq = sum(((x).^2).*aa*h);

    sigm_w(kk) = sqrt(sigma_sq);
end

figure
Z = peaks; surf(Z); 
axis tight
set(gca,'NextPlot','replacechildren');
% Preallocate the struct array for the struct returned by getframe
F(20) = struct('cdata',[],'colormap',[]);
% Record the movie
for j = 1:20 
    surf(.01+sin(2*pi*j/20)*Z,Z)
    F(j) = getframe;
end




figure; plot((1:Nk)*k,sigm_w,'b-');